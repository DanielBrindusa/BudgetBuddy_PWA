<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BudgetBuddy — Modern Budget PWA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#10141b">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    /* ======= Design System ======= */
    :root{
      --bg: #0c1117;
      --bg-grad: radial-gradient(1200px 800px at 20% -10%, #1a2332 0%, #0c1117 40%), radial-gradient(800px 600px at 120% -20%, #182031 0%, #0c1117 45%);
      --surface: rgba(255,255,255,0.04);
      --surface-2: rgba(255,255,255,0.06);
      --outline: rgba(255,255,255,0.10);
      --text: #e9eef6;
      --muted: #a8b3c7;
      --primary: #5dd3a1;
      --warn: #ff6b6b;
      --focus: #94c2ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --radius-sm: 10px;
      --blur: 10px;
      --speed: .25s;
      --speed-slow: .4s;
      --page-pad: clamp(16px, 4vw, 28px);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f7fb;
        --bg-grad: radial-gradient(1200px 800px at 20% -10%, #ffffff 0%, #f5f7fb 40%), radial-gradient(800px 600px at 120% -20%, #ffffff 0%, #f5f7fb 45%);
        --surface: rgba(0,0,0,0.04);
        --surface-2: rgba(0,0,0,0.06);
        --outline: rgba(0,0,0,0.10);
        --text:#0b1220; --muted:#3a4656;
        --primary:#1a7f5a; --warn:#c62828; --focus:#2458b6;
      }
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text); background: var(--bg); background-image: var(--bg-grad);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    /* ======= App Shell ======= */
    header{
      position: sticky; top:0; z-index: 10; backdrop-filter: blur(var(--blur)) saturate(1.2);
      background: linear-gradient(180deg, rgba(10,14,20,.75), rgba(10,14,20,.35), transparent);
      border-bottom: 1px solid var(--outline);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px var(--page-pad); }

    /* Header layout (two neat rows) */
    .brand{ display:flex; flex-direction:column; align-items:flex-start; gap:12px; margin:0 0 12px 0; }
    .brand-top{ display:flex; align-items:center; flex-wrap:wrap; gap:10px; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-start; }

    .logo{ width:34px; height:34px; border-radius:8px; background: radial-gradient(100% 100% at 30% 20%, #76f0c0, #2f7d62); box-shadow: 0 6px 16px rgba(93,211,161,.35), inset 0 0 20px rgba(255,255,255,.2); }
    .brand h1{ font-size:1.15rem; letter-spacing:.2px; margin:0 }
    .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--outline); background:var(--surface); padding:9px 12px; border-radius:999px; color:var(--muted); }
    .btn{
      appearance:none; border:1px solid var(--outline); background:linear-gradient(180deg, var(--surface-2), var(--surface));
      color:var(--text); padding:10px 14px; border-radius:999px; cursor:pointer;
      transition: transform var(--speed), box-shadow var(--speed), background var(--speed);
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
    }
    .btn:hover{ transform: translateY(-1px) }
    .btn:active{ transform: translateY(0) scale(.98) }
    .btn.primary{ border-color: color-mix(in oklab, var(--primary) 50%, var(--outline)); background: linear-gradient(180deg, color-mix(in oklab, var(--primary) 30%, transparent), var(--surface)); }
    .btn.danger{ border-color: color-mix(in oklab, var(--warn) 40%, var(--outline)); color: var(--warn); }
    .icon-btn{ padding:10px 12px }

    input[type="text"], input[type="number"], input[type="date"], input[type="month"], select, textarea{
      width:100%; padding:11px 12px; border-radius: var(--radius-sm);
      border:1px solid var(--outline); background: var(--surface); color:var(--text);
      outline:none; transition: border-color var(--speed), background var(--speed);
    }
    input:focus, select:focus, textarea:focus{ border-color: var(--focus); box-shadow: 0 0 0 4px color-mix(in oklab, var(--focus) 26%, transparent); background: var(--surface-2); }

    .grid{ display:grid; gap:16px }
    .grid-2{ grid-template-columns: 1fr }
    @media (min-width:980px){ .grid-2{ grid-template-columns: 2fr 1fr } }

    .card{
      border:1px solid var(--outline); border-radius: var(--radius);
      background: color-mix(in oklab, var(--surface) 80%, transparent);
      box-shadow: var(--shadow); backdrop-filter: blur(calc(var(--blur) * .6));
      transition: transform var(--speed-slow), box-shadow var(--speed-slow), border-color var(--speed);
    }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 14px 36px rgba(0,0,0,.38) }
    .card > .pad{ padding:16px }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end }
    label{ font-size:.9rem; color:var(--muted); display:block; margin:0 0 6px 4px }

    /* ======= Totals ======= */
    .totals{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:10px }
    .pill{ border:1px solid var(--outline); border-radius: var(--radius-sm); background: linear-gradient(180deg, var(--surface-2), var(--surface)); padding:14px 16px; text-align:center; position:relative; overflow:hidden; }
    .pill .label{ display:block; color:var(--muted); font-size:.9rem }
    .pill .val{ display:block; font-weight:700; font-size:1.25rem; letter-spacing:.2px }
    .income .val{ color: var(--primary) }
    .expense .val{ color: var(--warn) }

    /* ======= Tables ======= */
    .table-wrap{ overflow:auto; border-radius:0 0 var(--radius) var(--radius) }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid var(--outline); padding:12px; text-align:left; vertical-align:top }
    th{ color:var(--muted); font-weight:600; font-size:.9rem; backdrop-filter: blur(calc(var(--blur)*.4)); position:sticky; top:0; background: color-mix(in oklab, var(--surface) 75%, transparent); }
    tr{ transition: background var(--speed) }
    tr:hover td{ background: color-mix(in oklab, var(--surface) 50%, transparent) }
    .right{ text-align:right }
    .mono{ font-variant-numeric: tabular-nums }
    .cat{ padding:2px 10px; border-radius:999px; background: color-mix(in oklab, var(--surface) 65%, transparent); }

    /* Swipe affordance */
    tr.swipeable { touch-action: pan-y; }
    tr.swiping td { transition: none !important; }
    tr.swipe-delete td { background: color-mix(in oklab, var(--warn) 20%, transparent); }
    tr.swipe-edit td { background: color-mix(in oklab, var(--primary) 20%, transparent); }

    /* ======= Dialogs ======= */
    dialog{
      border:none; border-radius: var(--radius); background: color-mix(in oklab, var(--surface) 90%, transparent);
      color:var(--text); box-shadow: var(--shadow); border:1px solid var(--outline); width:min(720px, calc(100% - 32px));
      animation: pop .18s ease-out forwards; transform-origin: center;
      backdrop-filter: blur(var(--blur));
    }
    dialog::backdrop{ background: rgba(0,0,0,.35); backdrop-filter: blur(2px) }
    @keyframes pop{ from{ transform: scale(.96); opacity:.0 } to{ transform: scale(1); opacity:1 } }
    .dlg-head{ padding:14px 16px; border-bottom:1px solid var(--outline); font-weight:700 }
    .dlg-body{ padding:16px }
    .dlg-foot{ padding:12px 16px; border-top:1px solid var(--outline); display:flex; gap:8px; justify-content:flex-end }
    .dlg-postfoot{ padding:8px 16px 16px; text-align:center }
    .dlg-postfoot .hint{ display:inline-block; margin-top:6px }

    /* ======= Toasts & Chart ======= */
    .toasts{ position: fixed; right: 18px; bottom: 18px; display:flex; flex-direction:column; gap:10px; z-index: 9999; }
    .toast{ border:1px solid var(--outline); background: color-mix(in oklab, var(--surface) 96%, transparent); padding:10px 12px; border-radius: 10px; box-shadow: var(--shadow); transform: translateY(8px); opacity:0; animation: slideIn .22s ease-out forwards; }
    @keyframes slideIn { to { transform: translateY(0); opacity:1 } }
    .toast.good{ border-color: color-mix(in oklab, var(--primary) 40%, var(--outline)) }
    .toast.bad{ border-color: color-mix(in oklab, var(--warn) 40%, var(--outline)) }
    .chart-wrap{ padding:14px 16px 6px; }
    canvas{ width:100%; height:220px; display:block }

    /* ======= Small bits ======= */
    .row-center{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .hint{ color:var(--muted); font-size:.9rem }
    .sr-only{ position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden }
    footer{ color:var(--muted); padding:0 var(--page-pad) 26px; margin-top:16px }

    /* ======= Custom tooltip ======= */
    .bb-tooltip{
      position: fixed; z-index: 10000; pointer-events:none;
      background: color-mix(in oklab, var(--surface) 96%, transparent);
      border: 1px solid var(--outline);
      border-radius: 8px; padding:8px 10px; font-size:.9rem; color:var(--text);
      box-shadow: var(--shadow); opacity:0; transform: translateY(-4px);
      transition: opacity .12s ease-out, transform .12s ease-out;
      max-width: 280px;
    }
    .bb-tooltip.show{ opacity:1; transform: translateY(0); }
    /* Prevent scroll when a dialog is open */
    .modal-open{
      position: fixed; overflow: hidden; width: 100%;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <!-- Row 1 -->
        <div class="brand-top">
          <div class="logo" aria-hidden="true"></div>
          <h1>BudgetBuddy</h1>
          <span id="storageBadge" class="chip" data-tip="Where your data is saved">Storage: …</span>
          <button id="changeStorage" class="btn icon-btn" data-tip="Change storage location">Change</button>
          <button id="openSettings" class="btn icon-btn" data-tip="Currency & passcode">Settings</button>
          <button id="openRecurring" class="btn icon-btn" data-tip="Recurring transactions">Recurring</button>
          <button id="openTrash" class="btn icon-btn" data-tip="View deleted items">Trash</button>
        </div>
        <!-- Row 2 -->
        <div class="toolbar">
          <button id="exportCsv" class="btn" data-tip="Download all transactions as CSV">Export CSV</button>
          <button id="exportJson" class="btn" data-tip="Download everything as JSON">Export JSON</button>
          <label class="btn" for="importFile" data-tip="Import CSV or JSON">Import…</label>
          <input id="importFile" type="file" accept=".csv,.json,text/csv,application/json" class="sr-only" />
          <button id="clearAll" class="btn danger" data-tip="Reset all app data">Reset</button>
        </div>
        <div class="actionsRedo">
          <button id="undoBtn" class="btn" data-tip="Undo (Ctrl/Cmd+Z)">Undo</button>
          <button id="redoBtn" class="btn" data-tip="Redo (Ctrl/Cmd+Y)">Redo</button>
        </div>
      </div>

      <div class="filters">
        <div>
          <label for="month">Month</label>
          <input id="month" type="month" />
        </div>
        <div>
          <label for="typeFilter">Type</label>
          <select id="typeFilter"><option value="">All</option><option>EXPENSE</option><option>INCOME</option></select>
        </div>
        <div>
          <label for="categoryFilter">Category</label>
          <input id="categoryFilter" type="text" list="cats" placeholder="All" />
          <datalist id="cats"></datalist>
        </div>
        <br><br>
        <div class="row-center">
          <span class="chip" data-tip="Display currency"><strong id="currLabel" style="margin-left:6px">USD</strong></span>
          <button id="lockNow" class="btn" data-tip="Lock the app right now">Lock now</button>
        </div>
      </div>

      <div class="totals" role="status" aria-live="polite">
        <div class="pill income"><span class="label">Income</span><span id="tIncome" class="val mono">0.00</span></div>
        <div class="pill expense"><span class="label">Expense</span><span id="tExpense" class="val mono">0.00</span></div>
        <div class="pill"><span class="label">Balance</span><span id="tBalance" class="val mono">0.00</span></div>
      </div>
      <div class="row-center" style="margin-top:10px">
        <span id="paceChip" class="chip" data-tip="Spending pace for this month">Pace: —</span>
      </div>
    </div>
  </header>

  <main class="wrap grid grid-2" style="padding-top:16px; padding-bottom:24px">
    <!-- Transactions -->
    <section class="card">
      <div class="pad">
        <h2 style="margin:0 0 12px">Transactions</h2>
        <form id="txForm" class="row" autocomplete="off">
          <div style="min-width:130px">
            <label for="txType">Type</label>
            <select id="txType"><option>EXPENSE</option><option>INCOME</option></select>
          </div>
          <div>
            <label for="txAmount">Amount</label>
            <input id="txAmount" inputmode="decimal" type="number" step="0.01" placeholder="0.00" required />
          </div>
          <div>
            <label for="txCategory">Category</label>
            <input id="txCategory" type="text" list="cats" placeholder="Groceries" required />
          </div>
          <div>
            <label for="txDate">Date</label>
            <input id="txDate" type="date" required />
          </div>
          <div style="flex:1 1 100%">
            <label for="txNote">Note</label>
            <input id="txNote" type="text" placeholder="(optional)" />
          </div>
          <div class="row" style="justify-content:flex-end; gap:8px; flex:1 1 100%">
            <button class="btn primary" type="submit">Add</button>
            <button class="btn" type="reset">Clear</button>
          </div>
        </form>
      </div>

      <div class="chart-wrap">
        <div class="row" style="justify-content:space-between; align-items:center">
          <strong>Monthly expense by category</strong>
          <span class="hint">Animated • current month filter</span>
        </div>
        <canvas id="catChart" aria-label="Category chart"></canvas>
      </div>

      <div class="table-wrap">
        <table aria-label="Transactions">
          <thead>
            <tr><th>Date</th><th>Type</th><th>Category</th><th class="right">Amount</th><th>Note</th><th class="right nowrap">Actions</th></tr>
          </thead>
          <tbody id="txTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Budgets -->
    <aside class="card">
      <div class="pad">
        <h2 style="margin:0 0 12px">Budgets</h2>
        <form id="budForm" class="row" autocomplete="off">
          <div style="flex:2 1 160px">
            <label for="budCat">Category</label>
            <input id="budCat" type="text" list="cats" placeholder="Groceries" required />
          </div>
          <div style="flex:1 1 120px">
            <label for="budLimit">Monthly Limit</label>
            <input id="budLimit" type="number" step="0.01" placeholder="0.00" required />
          </div>
          <div class="row" style="justify-content:flex-end; gap:8px; flex:1 1 100%">
            <button class="btn primary" type="submit">Save Budget</button>
          </div>
        </form>
      </div>
      <div class="table-wrap">
        <table aria-label="Budgets">
          <thead>
            <tr><th>Category</th><th class="right">Limit</th><th class="right">Spent (month)</th><th class="right">Remaining</th><th class="right">Actions</th></tr>
          </thead>
          <tbody id="budTbody"></tbody>
        </table>
      </div>
      <p class="pad hint">Budgets apply to the selected month.</p>
    </aside>
  </main>

  <footer class="wrap">
    No servers. Your data stays on your device (browser storage or a file you choose). ✨
  </footer>

  <!-- Edit Transaction -->
  <dialog id="editDlg" aria-modal="true">
    <div class="dlg-head">Edit transaction</div>
    <form method="dialog" class="dlg-body" id="editForm">
      <input type="hidden" id="editId" />
      <div class="row">
        <div>
          <label for="editType">Type</label>
          <select id="editType"><option>EXPENSE</option><option>INCOME</option></select>
        </div>
        <div>
          <label for="editAmount">Amount</label>
          <input id="editAmount" type="number" step="0.01" required />
        </div>
        <div>
          <label for="editCategory">Category</label>
          <input id="editCategory" type="text" list="cats" required />
        </div>
        <div>
          <label for="editDate">Date</label>
          <input id="editDate" type="date" required />
        </div>
        <div style="flex:1 1 100%">
          <label for="editNote">Note</label>
          <textarea id="editNote" style="width:100%; min-height:70px"></textarea>
        </div>
      </div>
    </form>
    <div class="dlg-foot">
      <button class="btn danger" id="editDelete">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" id="editCancel">Cancel</button>
      <button class="btn primary" id="editSave">Save</button>
    </div>
  </dialog>

  <!-- Storage Choice -->
  <dialog id="storageDlg" aria-modal="true">
    <div class="dlg-head">Where should we save your data?</div>
    <div class="dlg-body">
      <p>You can store your budgets & transactions either:</p>
      <ul>
        <li><strong>Browser Storage</strong> — works offline, easiest.</li>
        <li><strong>Chosen JSON file</strong> — you pick a file; the app saves into it each time.</li>
      </ul>
    </div>
    <div class="dlg-foot">
      <button class="btn" id="pickBrowser">Use Browser Storage</button>
      <button class="btn primary" id="pickFile">Choose a Data File…</button>
    </div>
    <div class="dlg-postfoot">
      <span class="hint">No servers. Your data stays on your device (browser storage or file you choose). ✨</span>
    </div>
  </dialog>

  <!-- Settings (currency & passcode & auto-lock) -->
  <dialog id="settingsDlg" aria-modal="true">
    <div class="dlg-head">Settings</div>
    <div class="dlg-body">
      <h3 style="margin:0 0 10px">Currency</h3>
      <div class="row">
        <div style="min-width:200px">
          <label for="currencySelect">Currency</label>
          <select id="currencySelect">
            <option value="USD">USD — US Dollar</option>
            <option value="EUR">EUR — Euro</option>
            <option value="RON">RON — Romanian Leu</option>
            <option value="GBP">GBP — British Pound</option>
            <option value="JPY">JPY — Japanese Yen</option>
            <option value="AUD">AUD — Australian Dollar</option>
            <option value="CAD">CAD — Canadian Dollar</option>
            <option value="INR">INR — Indian Rupee</option>
            <option value="BRL">BRL — Brazilian Real</option>
          </select>
        </div>
        <div>
          <label for="customCurr">…or custom code</label>
          <input id="customCurr" type="text" maxlength="5" placeholder="e.g. CHF" />
        </div>
      </div>

      <hr style="border:none; border-top:1px solid var(--outline); margin:16px 0">

      <h3 style="margin:0 0 10px">Passcode & Auto-lock</h3>
      <p class="hint">Quick privacy lock (not encryption). Auto-lock works when the app goes to the background.</p>
      <div class="row">
        <div>
          <label for="newPin">New passcode (4–8 digits)</label>
          <input id="newPin" type="password" inputmode="numeric" pattern="\\d*" minlength="4" maxlength="8" placeholder="••••" />
        </div>
        <div>
          <label for="confirmPin">Confirm</label>
          <input id="confirmPin" type="password" inputmode="numeric" pattern="\\d*" minlength="4" maxlength="8" placeholder="••••" />
        </div>
      </div>
      <div class="row">
        <button id="savePin" class="btn">Save Passcode</button>
        <button id="clearPin" class="btn danger">Remove Passcode</button>
      </div>

      <div class="row" style="margin-top:8px">
        <label class="chip" style="cursor:pointer">
          <input id="autoLockToggle" type="checkbox" style="margin-right:8px; transform:translateY(1px)"> Auto-lock when app goes to background
        </label>
      </div>
    </div>
    <div class="dlg-foot">
      <button class="btn" id="closeSettings">Close</button>
      <button class="btn primary" id="saveCurrency">Save</button>
    </div>
  </dialog>

  <!-- Lock Screen -->
  <dialog id="lockDlg" aria-modal="true">
    <div class="dlg-head">Enter passcode</div>
    <div class="dlg-body">
      <div id="lockInfo" class="hint" style="margin-bottom:8px"></div>
      <input id="pinEntry" type="password" inputmode="numeric" pattern="\\d*" minlength="4" maxlength="8" placeholder="••••" style="width:200px">
    </div>
    <div class="dlg-foot">
      <button class="btn primary" id="unlockBtn">Unlock</button>
    </div>
  </dialog>

  <!-- Recurring transactions -->
  <dialog id="recurringDlg" aria-modal="true">
    <div class="dlg-head">Recurring transactions</div>
    <div class="dlg-body">
      <form id="recForm" class="row" autocomplete="off">
        <div style="min-width:130px">
          <label for="recType">Type</label>
          <select id="recType"><option>EXPENSE</option><option>INCOME</option></select>
        </div>
        <div>
          <label for="recAmount">Amount</label>
          <input id="recAmount" type="number" step="0.01" placeholder="0.00" required />
        </div>
        <div>
          <label for="recCategory">Category</label>
          <input id="recCategory" type="text" list="cats" placeholder="Rent / Salary" required />
        </div>
        <div>
          <label for="recStart">Start date</label>
          <input id="recStart" type="date" />
        </div>
        <div>
          <label for="recFreq">Frequency</label>
          <select id="recFreq">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly" selected>Monthly</option>
          </select>
        </div>
        <div style="flex:1 1 100%">
          <label for="recNote">Note</label>
          <input id="recNote" type="text" placeholder="(optional)" />
        </div>
        <div class="row" style="justify-content:flex-end; gap:8px; flex:1 1 100%">
          <button class="btn primary" type="submit">Add recurring</button>
        </div>
      </form>

      <div class="table-wrap" style="margin-top:10px">
        <table aria-label="Recurring">
          <thead>
            <tr><th>Next</th><th>Freq</th><th>Type</th><th>Category</th><th class="right">Amount</th><th>Note</th><th class="right">Actions</th></tr>
          </thead>
          <tbody id="recTbody"></tbody>
        </table>
      </div>
      <p class="hint">Due items auto‑post on open and show a reminder toast.</p>
    </div>
    <div class="dlg-foot">
      <button class="btn" id="closeRecurring">Close</button>
    </div>
  </dialog>

  <!-- Trash bin -->
  <dialog id="trashDlg" aria-modal="true">
    <div class="dlg-head">Trash bin</div>
    <div class="dlg-body">
      <div class="table-wrap">
        <table aria-label="Trash">
          <thead>
            <tr><th>Deleted</th><th>Date</th><th>Type</th><th>Category</th><th class="right">Amount</th><th>Note</th><th class="right">Actions</th></tr>
          </thead>
          <tbody id="trashTbody"></tbody>
        </table>
      </div>
      <p class="hint">Items stay here until you purge them.</p>
    </div>
    <div class="dlg-foot">
      <button class="btn danger" id="purgeTrash">Purge all</button>
      <button class="btn" id="closeTrash">Close</button>
    </div>
  </dialog>

  <!-- Toasts -->
  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
  (() => {
    /* ===== Utilities ===== */
    const $ = s => document.querySelector(s);
    const fmtNum = (n, curr) => {
      try { return new Intl.NumberFormat(undefined, { style:'currency', currency: curr, maximumFractionDigits:2 }).format(n||0); }
      catch { return new Intl.NumberFormat(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 }).format(n||0); }
    };
    const todayISO = () => new Date().toISOString().slice(0,10);
    const toISO = d => (typeof d === "string" ? d : new Date(d).toISOString().slice(0,10));
    const monthBounds = (yyyyMm) => { const [y,m] = (yyyyMm || todayISO().slice(0,7)).split("-").map(Number); const start = new Date(Date.UTC(y, m-1, 1)); const end = new Date(Date.UTC(y, m, 0)); return { start: start.toISOString().slice(0,10), end: end.toISOString().slice(0,10) }; };
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const addDays = (iso, n)=> toISO(new Date(new Date(iso).getTime()+n*86400000));
    const addMonths = (iso, n)=>{ const d=new Date(iso); d.setUTCMonth(d.getUTCMonth()+n); return toISO(d); };

    function toast(msg, kind='good'){
      const host=$("#toasts");
      const t=document.createElement("div");
      t.className=`toast ${kind}`;
      t.textContent=msg;
      host.appendChild(t);
      setTimeout(()=>{t.style.opacity=.9},10);
      setTimeout(()=>{
        t.style.opacity=0; t.style.transform='translateY(8px)';
        t.addEventListener('transitionend',()=>t.remove(),{once:true});
      }, 3000);
    }

    async function sha256Hex(str){ const data=new TextEncoder().encode(str); const hash=await crypto.subtle.digest('SHA-256',data); return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

    /* ===== Persistence ===== */
    const LS_KEY = "BudgetBuddy.v7";
    const MODE_KEY = "mode";

    const idb = {
      db:null,
      async open(){ await new Promise((res,rej)=>{ const req=indexedDB.open("BudgetBuddyStore",2); req.onupgradeneeded=()=>{const db=req.result; if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');}; req.onsuccess=()=>{this.db=req.result; res()}; req.onerror=()=>rej(req.error); }); },
      get(key){ return new Promise((res,rej)=>{ const r=this.db.transaction('kv','readonly').objectStore('kv').get(key); r.onsuccess=()=>res(r.result??null); r.onerror=()=>rej(r.error); }); },
      set(key,val){ return new Promise((res,rej)=>{ const r=this.db.transaction('kv','readwrite').objectStore('kv').put(val,key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); },
      del(key){ return new Promise((res,rej)=>{ const r=this.db.transaction('kv','readwrite').objectStore('kv').delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); },
    };

    let storageMode='local';
    let fileHandle=null;

    function lsLoad(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'null') }catch{ return null } }
    function lsSave(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)) }
    async function verifyPermission(handle,mode='readwrite'){ const opt={mode}; if((await handle.queryPermission(opt))==='granted')return true; if((await handle.requestPermission(opt))==='granted')return true; return false; }

    /* ===== State ===== */
    const state={
      transactions:[],
      budgets:{},
      recurring:[],
      trash:[],
      nextId:1,
      settings:{ currency:'USD', passcodeHash:null, autoLock:true }
    };

    const currency=()=>state.settings.currency||'USD';
    const money=n=>fmtNum(n,currency());
    const maxId=()=>state.transactions.reduce((m,t)=>Math.max(m,Number(t.id)||0),0);

    /* ===== Undo/Redo ===== */
    const undoStack=[]; const redoStack=[];
    const snapshot = ()=> JSON.stringify({transactions:state.transactions, budgets:state.budgets, recurring:state.recurring, trash:state.trash, nextId:state.nextId});
    function pushUndo(){ undoStack.push(snapshot()); redoStack.length=0; }
    function applySnapshot(json){ const s=JSON.parse(json); state.transactions=s.transactions||[]; state.budgets=s.budgets||{}; state.recurring=s.recurring||[]; state.trash=s.trash||[]; state.nextId=s.nextId||1; persist(); render(); }
    $("#undoBtn").addEventListener("click",()=>{ if(!undoStack.length){ toast('Nothing to undo','bad'); return; } redoStack.push(snapshot()); applySnapshot(undoStack.pop()); });
    $("#redoBtn").addEventListener("click",()=>{ if(!redoStack.length){ toast('Nothing to redo','bad'); return; } undoStack.push(snapshot()); applySnapshot(redoStack.pop()); });
    document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); $("#undoBtn").click(); } if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='y'){ e.preventDefault(); $("#redoBtn").click(); } });

    /* ===== Core helpers ===== */
    function computeTotals(rows){ const inc=rows.filter(t=>t.type==='INCOME').reduce((s,t)=>s+t.amount,0); const exp=rows.filter(t=>t.type==='EXPENSE').reduce((s,t)=>s+t.amount,0); return {income:inc, expense:exp, balance:inc-exp}; }
    function renderStorageBadge(){ $("#storageBadge").textContent = storageMode==='file' ? 'Storage: File' : 'Storage: Browser'; $("#currLabel").textContent=currency(); }
    function refreshCategoryDatalist(){ const dl=$("#cats"); dl.innerHTML=""; const cats=[...new Set(state.transactions.map(t=>t.category).concat(Object.keys(state.budgets)).concat(state.recurring.map(r=>r.category)))].filter(Boolean).sort(); for(const c of cats){ const o=document.createElement("option"); o.value=c; dl.appendChild(o);} }
    function listFiltered(){ const yyyyMm=$("#month").value || todayISO().slice(0,7); const {start,end}=monthBounds(yyyyMm); const type=$("#typeFilter").value; const cat=($("#categoryFilter").value||"").trim().toLowerCase(); return state.transactions.filter(t=>t.date>=start && t.date<=end).filter(t=>!type || t.type===type).filter(t=>!cat || t.category.toLowerCase()===cat).sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id); }

    function spendingPace(){
      const yyyyMm=$("#month").value || todayISO().slice(0,7);
      const {start,end}=monthBounds(yyyyMm);
      const now=new Date().toISOString().slice(0,10);
      const daysInMonth = Number(end.slice(-2));
      const day = Math.min(daysInMonth, Number(now.slice(-2)));
      const exp = state.transactions.filter(t=>t.type==='EXPENSE' && t.date>=start && t.date<=end).reduce((s,t)=>s+t.amount,0);
      const totalBudget = Object.values(state.budgets).reduce((s,v)=>s+Number(v||0),0);
      if(totalBudget<=0){ $("#paceChip").textContent="Pace: set budgets to track"; return; }
      const expected = totalBudget * (day/daysInMonth);
      const diff = exp - expected;
      const pct = Math.abs(expected? (diff/expected*100):0);
      $("#paceChip").textContent = diff>0 ? `Pace: over by ${money(diff)} (${pct.toFixed(0)}%)` : `Pace: under by ${money(-diff)} (${pct.toFixed(0)}%)`;
    }

    function render(){
      const rows=listFiltered();
      const t=computeTotals(rows);
      $("#tIncome").textContent=money(t.income);
      $("#tExpense").textContent=money(t.expense);
      $("#tBalance").textContent=money(t.balance);

      const tb=$("#txTbody"); tb.innerHTML="";
      for(const r of rows){
        const tr=document.createElement("tr");
        tr.classList.add('swipeable');
        tr.setAttribute('data-id', r.id);
        tr.innerHTML=`<td class="mono">${r.date}</td><td>${r.type}</td><td><span class="cat">${escapeHtml(r.category)}</span></td><td class="right mono">${r.type==="INCOME"?"+":"-"}${money(r.amount)}</td><td>${escapeHtml(r.note||"")}</td><td class="right"><button class="btn" data-edit="${r.id}" data-tip="Edit this transaction">Edit</button> <button class="btn danger" data-del="${r.id}" data-tip="Move to Trash">Delete</button></td>`;
        tb.appendChild(tr);
      }
      hookSwipeRows();

      const budTb=$("#budTbody"); budTb.innerHTML="";
      const cats=Object.keys(state.budgets).sort((a,b)=>a.localeCompare(b));
      for(const c of cats){
        const limit=state.budgets[c]||0; const spent=spentInMonth(c); const remaining=limit-spent; const red=remaining<0?"style='color:var(--warn)'":"";
        const tr=document.createElement("tr");
        tr.innerHTML=`<td><span class="cat">${escapeHtml(c)}</span></td><td class="right mono">${money(limit)}</td><td class="right mono">${money(spent)}</td><td class="right mono" ${red}>${money(remaining)}</td><td class="right"><button class="btn" data-bud-edit="${encodeURIComponent(c)}" data-tip="Edit budget">Edit</button> <button class="btn danger" data-bud-del="${encodeURIComponent(c)}" data-tip="Delete budget">Delete</button></td>`;
        budTb.appendChild(tr);
      }
      refreshCategoryDatalist();
      drawCategoryChart();
      spendingPace();
      renderRecurringTable();
    }
    function spentInMonth(category){ const yyyyMm=$("#month").value || todayISO().slice(0,7); const {start,end}=monthBounds(yyyyMm); return state.transactions.filter(t=>t.type==="EXPENSE" && t.category===category && t.date>=start && t.date<=end).reduce((s,t)=>s+t.amount,0); }

    async function fileSave(){ if(!fileHandle) return; try{ const ok=await verifyPermission(fileHandle,'readwrite'); if(!ok) throw new Error('Permission denied'); const w=await fileHandle.createWritable(); await w.write(new Blob([JSON.stringify(state,null,2)],{type:'application/json'})); await w.close(); }catch(e){ console.warn('file save failed',e); toast('Saving failed — switched to Browser Storage','bad'); storageMode='local'; await idb.set(MODE_KEY,storageMode); await idb.del('dataHandle'); fileHandle=null; lsSave({...state,[MODE_KEY]:storageMode}); renderStorageBadge(); } }
    async function fileLoad(){ try{ const ok=await verifyPermission(fileHandle,'read'); if(!ok) return false; const text=await (await fileHandle.getFile()).text(); const obj=JSON.parse(text);
      state.transactions=(obj.transactions||[]).map(t=>({ id:Number(t.id), date:toISO(t.date), amount:Math.abs(Number(t.amount)||0), type:(String(t.type).toUpperCase()==='INCOME'?'INCOME':'EXPENSE'), category:String(t.category||'General'), note:String(t.note||'') }));
      state.budgets=obj.budgets||{}; state.settings={ currency:obj.settings?.currency||'USD', passcodeHash:obj.settings?.passcodeHash||null, autoLock: !!obj.settings?.autoLock };
      state.recurring=obj.recurring||[]; state.trash=obj.trash||[]; state.nextId=Number.isFinite(obj.nextId)?obj.nextId:(maxId()+1); return true; }catch{ return false } }
    function lsSync(){ lsSave({...state,[MODE_KEY]:storageMode}) }
    async function persist(){ (storageMode==='file') ? await fileSave() : lsSync() }

    /* ===== Transactions CRUD ===== */
    function add(tx){ pushUndo(); const t={ id:state.nextId++, date:toISO(tx.date||todayISO()), amount:Math.abs(Number(tx.amount)||0), type:(String(tx.type||'EXPENSE').toUpperCase()==='INCOME'?'INCOME':'EXPENSE'), category:(tx.category||'General').toString(), note:(tx.note||'').toString() }; state.transactions.push(t); persist(); toast(`${t.type==='INCOME'?'Income':'Expense'} added`,'good'); return t; }
    function updateTx(id,patch){ pushUndo(); const t=state.transactions.find(x=>x.id===id); if(!t) return null; if(patch.amount!=null) t.amount=Math.abs(Number(patch.amount)||0); if(patch.type) t.type=(String(patch.type).toUpperCase()==='INCOME'?'INCOME':'EXPENSE'); if(patch.category!=null) t.category=String(patch.category); if(patch.date) t.date=toISO(patch.date); if(patch.note!=null) t.note=String(patch.note); persist(); toast('Transaction updated','good'); return t; }
    function removeTx(id){ pushUndo(); const i=state.transactions.findIndex(t=>t.id===id); if(i>=0){ const [deleted]=state.transactions.splice(i,1); state.trash.unshift({ ...deleted, deletedAt: Date.now() }); persist(); toast('Transaction deleted (moved to Trash)','good'); return true;} return false; }

    /* ===== CSV/JSON ===== */
    const csvEscape=s=>{ const v=String(s??""); return /[",\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v; };
    function toCSV(rows){ const header="id,date,amount,type,category,note"; const body=rows.map(t=>[t.id,t.date,t.amount,t.type,csvEscape(t.category),csvEscape(t.note)].join(",")).join("\n"); return header+"\n"+body; }
    function parseCSV(text){ const lines=text.trim().split(/\r?\n/); const hdr=lines.shift()||""; if(!/id,date,amount,type,category,note/i.test(hdr)) throw new Error("CSV header must be id,date,amount,type,category,note"); const out=[]; for(const line of lines){ if(!line.trim()) continue; const cols=[]; let cur="",inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(inQ){ if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; } else if(ch==='"') inQ=false; else cur+=ch; } else { if(ch===','){ cols.push(cur); cur="" } else if(ch==='"'){ inQ=true } else cur+=ch; } } cols.push(cur); const [idStr,dateStr,amountStr,type,category,note]=cols; out.push({ id:Number(idStr)||(maxId()+1+out.length), date:toISO(dateStr), amount:Math.abs(Number(amountStr)||0), type:(String(type).toUpperCase()==="INCOME"?"INCOME":"EXPENSE"), category:String(category||"General"), note:String(note||"") }); } return out; }
    function downloadFile(name,content,mime){ const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    /* ===== Chart ===== */
    let chartAnim=null;
    function calcCategoryData(){ const yyyyMm=$("#month").value||todayISO().slice(0,7); const {start,end}=monthBounds(yyyyMm); const map=new Map(); for(const t of state.transactions){ if(t.type!=='EXPENSE') continue; if(t.date<start || t.date>end) continue; map.set(t.category,(map.get(t.category)||0)+t.amount); } const entries=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10); return { labels:entries.map(e=>e[0]), values:entries.map(e=>e[1]) }; }
    function drawCategoryChart(){ const canvas=$("#catChart"); const ctx=canvas.getContext('2d'); const rect=canvas.getBoundingClientRect(); const dpr=window.devicePixelRatio||1; canvas.width=Math.floor(rect.width*dpr); canvas.height=Math.floor(220*dpr); ctx.scale(dpr,dpr); const {labels,values}=calcCategoryData(); ctx.clearRect(0,0,canvas.width,canvas.height); const pad={l:14,r:10,t:10,b:36}; const w=rect.width-pad.l-pad.r; const h=220-pad.t-pad.b; ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+h); ctx.lineTo(pad.l+w,pad.t+h); ctx.stroke(); if(values.length===0){ ctx.fillStyle='rgba(255,255,255,0.55)'; ctx.fillText('No expenses this month yet', pad.l+8, pad.t+h/2); return; } const max=Math.max(...values); const barW=Math.max(18, w/Math.max(1, values.length*1.6)); const gap=Math.min(20,(w-barW*values.length)/Math.max(1,values.length-1)); const start=performance.now(), duration=400; cancelAnimationFrame(chartAnim); function frame(now){ const t=Math.min(1,(now-start)/duration); const e=t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2; ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+h); ctx.lineTo(pad.l+w,pad.t+h); ctx.stroke(); for(let i=0;i<values.length;i++){ const x=pad.l+i*(barW+gap); const val=values[i]; const bh=(val/max)*h*e; const grd=ctx.createLinearGradient(x,pad.t+h,x,pad.t+h-bh); grd.addColorStop(0,'rgba(93,211,161,0.25)'); grd.addColorStop(1,'rgba(93,211,161,0.85)'); ctx.fillStyle=grd; ctx.fillRect(x,pad.t+h-bh,barW,bh); ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.font='12px system-ui, Segoe UI, Roboto'; const lbl=labels[i].length>10?labels[i].slice(0,10)+'…':labels[i]; ctx.fillText(lbl,x,pad.t+h+14); ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.font='11px system-ui, Segoe UI, Roboto'; ctx.fillText(money(val), x, pad.t+h-bh-6); } if(t<1) chartAnim=requestAnimationFrame(frame); } chartAnim=requestAnimationFrame(frame); }
    window.addEventListener('resize', drawCategoryChart);

    /* ===== Recurring ===== */
    function nextAfter(freq, iso){
      if(freq==='daily') return addDays(iso,1);
      if(freq==='weekly') return addDays(iso,7);
      return addMonths(iso,1);
    }
    function processRecurring(){
      const today=todayISO();
      let posted=0;
      for(const r of state.recurring){
        while(r.nextDate && r.nextDate<=today){
          add({ type:r.type, amount:r.amount, category:r.category, date:r.nextDate, note:r.note||'(recurring)' });
          r.nextDate = nextAfter(r.freq, r.nextDate);
          posted++;
        }
      }
      if(posted>0){ persist(); render(); toast(`Auto‑posted ${posted} recurring item${posted>1?'s':''}`); }
    }
    function renderRecurringTable(){
      const tb=$("#recTbody"); if(!tb) return; tb.innerHTML="";
      for(const r of state.recurring.sort((a,b)=>a.nextDate.localeCompare(b.nextDate))){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="mono">${r.nextDate||'—'}</td><td>${r.freq}</td><td>${r.type}</td><td><span class="cat">${escapeHtml(r.category)}</span></td><td class="right mono">${r.type==='INCOME'?'+':'-'}${money(r.amount)}</td><td>${escapeHtml(r.note||'')}</td><td class="right"><button class="btn" data-rec-edit="${r.id}" data-tip="Edit">Edit</button> <button class="btn danger" data-rec-del="${r.id}" data-tip="Delete">Delete</button></td>`;
        tb.appendChild(tr);
      }
    }

    /* ===== Trash ===== */
    function renderTrash(){
      const tb=$("#trashTbody"); tb.innerHTML="";
      for(const t of state.trash){
        const when=new Date(t.deletedAt||Date.now()).toLocaleString();
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${when}</td><td class="mono">${t.date}</td><td>${t.type}</td><td><span class="cat">${escapeHtml(t.category)}</span></td><td class="right mono">${t.type==='INCOME'?'+':'-'}${money(t.amount)}</td><td>${escapeHtml(t.note||'')}</td><td class="right"><button class="btn" data-restore="${t.id}" data-tip="Restore">Restore</button></td>`;
        tb.appendChild(tr);
      }
    }

    /* ===== Swipe actions (mobile) ===== */
    function hookSwipeRows(){
      const rows=[...document.querySelectorAll('#txTbody tr.swipeable')];
      rows.forEach(tr=>{
        let startX=0, dx=0, active=false;
        function onStart(e){ active=true; tr.classList.add('swiping'); startX=(e.touches?e.touches[0].clientX:e.clientX); }
        function onMove(e){ if(!active) return; const x=(e.touches?e.touches[0].clientX:e.clientX); dx=x-startX; tr.style.transform=`translateX(${dx}px)`; tr.classList.toggle('swipe-delete', dx<-40); tr.classList.toggle('swipe-edit', dx>40); }
        function onEnd(){ if(!active) return; active=false; tr.classList.remove('swiping'); tr.style.transition='transform .18s ease'; const id=Number(tr.getAttribute('data-id'));
          if(dx<-80){ tr.style.transform='translateX(-120%)'; setTimeout(()=>{ removeTx(id); render(); },160);
          } else if(dx>80){ tr.style.transform='translateX(120%)'; setTimeout(()=>{ const t=state.transactions.find(x=>x.id===id); if(!t) return; $("#editId").value=String(t.id); $("#editType").value=t.type; $("#editAmount").value=String(t.amount); $("#editCategory").value=t.category; $("#editDate").value=t.date; $("#editNote").value=t.note||""; $("#editDlg").showModal(); tr.style.transform=''; },160);
          } else { tr.style.transform=''; }
          tr.classList.remove('swipe-delete','swipe-edit'); setTimeout(()=>{ tr.style.transition=''; },200);
          dx=0;
        }
        tr.addEventListener('touchstart',onStart,{passive:true});
        tr.addEventListener('touchmove',onMove,{passive:true});
        tr.addEventListener('touchend',onEnd);
        tr.addEventListener('mousedown',onStart);
        tr.addEventListener('mousemove',onMove);
        tr.addEventListener('mouseup',onEnd);
        tr.addEventListener('mouseleave',onEnd);
      });
    }

    /* ===== Scroll lock while dialogs are open ===== */
    let scrollYStore=0, openDialogs=0;
    function lockBodyScroll(){
      if(openDialogs===0){
        scrollYStore = window.scrollY || document.documentElement.scrollTop;
        document.body.classList.add('modal-open');
        document.body.style.top = `-${scrollYStore}px`;
      }
      openDialogs++;
    }
    function unlockBodyScroll(){
      openDialogs = Math.max(0, openDialogs-1);
      if(openDialogs===0){
        document.body.classList.remove('modal-open');
        document.body.style.top = '';
        window.scrollTo(0, scrollYStore);
      }
    }
    function attachScrollLock(dlg){
      dlg.addEventListener('close', unlockBodyScroll);
      dlg.addEventListener('cancel', unlockBodyScroll);
      // showModal is called in code; hook into open points:
      const origShow = dlg.showModal.bind(dlg);
      dlg.showModal = (...args)=>{ lockBodyScroll(); origShow(...args); };
    }

    // helper for lock info that auto-clears after 3s
    function setLockInfo(msg, autoMs=3000){
      const info=$("#lockInfo");
      info.textContent = msg || '';
      if(info._timer) clearTimeout(info._timer);
      if(autoMs){
        info._timer = setTimeout(()=>{ info.textContent=''; }, autoMs);
      }
    }

    /* ===== Init & Lock ===== */
    async function init(){
      $("#month").value=todayISO().slice(0,7); $("#txDate").value=todayISO();
      await idb.open();
      const ls=lsLoad(); const storedMode=(ls && ls[MODE_KEY]) || await idb.get(MODE_KEY); if(storedMode) storageMode=storedMode;
      const maybeHandle=await idb.get('dataHandle'); if(maybeHandle) fileHandle=maybeHandle;

      let loaded=false;
      if(storageMode==='file' && fileHandle){ loaded=await fileLoad(); if(!loaded){ storageMode='local'; await idb.set(MODE_KEY,'local'); await idb.del('dataHandle'); fileHandle=null; } }
      if(!loaded && ls){
        state.transactions=Array.isArray(ls.transactions)?ls.transactions:[]; 
        state.budgets=ls.budgets&&typeof ls.budgets==="object"?ls.budgets:{}; 
        state.recurring=Array.isArray(ls.recurring)?ls.recurring:[]; 
        state.trash=Array.isArray(ls.trash)?ls.trash:[]; 
        state.settings=ls.settings&&typeof ls.settings==="object"?{...state.settings,...ls.settings}:state.settings; 
        state.nextId=Number.isFinite(ls.nextId)?ls.nextId:(maxId()+1);
      }

      render(); renderStorageBadge();
      const firstTime=!storedMode && state.transactions.length===0 && Object.keys(state.budgets).length===0; if(firstTime) $("#storageDlg").showModal();
      if(state.settings.passcodeHash) await lockScreen(true);

      $("#currencySelect").value=state.settings.currency || 'USD';
      $("#currLabel").textContent=currency();
      $("#autoLockToggle").checked=!!state.settings.autoLock;

      // Process due recurring items at startup
      processRecurring();

      // Install scroll lock on dialogs
      ['editDlg','storageDlg','settingsDlg','lockDlg','recurringDlg','trashDlg'].forEach(id=> attachScrollLock(document.getElementById(id)));

      document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ if(state.settings.passcodeHash && state.settings.autoLock){ localStorage.setItem('bb_should_lock','1'); } } else { const should=localStorage.getItem('bb_should_lock'); if(should==='1' && state.settings.passcodeHash){ localStorage.removeItem('bb_should_lock'); lockScreen(); } } });

      // Init tooltips (after DOM ready)
      initTooltips();
    }

    // Lock with chill-down & destructive delete after repeated failures
    const CHILLS = [15, 60, 300]; // seconds
    async function lockScreen(first=false){
      const dlg=$("#lockDlg"); const input=$("#pinEntry");
      setLockInfo('');
      dlg.showModal(); await sleep(30); input.focus();

      function getState(){
        return {
          attempts: Number(localStorage.getItem('bb_fail_attempts')||'0'),
          chills: Number(localStorage.getItem('bb_chill_count')||'0'),
          coolUntil: Number(localStorage.getItem('bb_cool_until')||'0'),
          postChillAttempts: Number(localStorage.getItem('bb_post_chill_attempts')||'0')
        };
      }
      function setState(obj){
        for(const [k,v] of Object.entries(obj)){
          if(k==='attempts') localStorage.setItem('bb_fail_attempts', String(v));
          if(k==='chills') localStorage.setItem('bb_chill_count', String(v));
          if(k==='coolUntil') localStorage.setItem('bb_cool_until', String(v));
          if(k==='postChillAttempts') localStorage.setItem('bb_post_chill_attempts', String(v));
        }
      }
      function resetAll(){ setState({attempts:0, chills:0, coolUntil:0, postChillAttempts:0}); }

      async function maybeWipe(){
        state.transactions=[]; state.budgets={}; state.recurring=[]; state.trash=[]; state.nextId=1;
        await persist(); render(); resetAll(); toast('All data wiped due to repeated failed passcode attempts','bad');
      }

      async function checkCooldown(){
        const st=getState();
        const now=Date.now();
        if(st.coolUntil && now<st.coolUntil){
          const update=()=> {
            const left=Math.ceil((st.coolUntil-Date.now())/1000);
            if(left>0){
              $("#unlockBtn").disabled=true; input.disabled=true;
              setLockInfo(`Locked. Try again in ${left}s.`, 0);
            } else {
              clearInterval(iv); $("#unlockBtn").disabled=false; input.disabled=false; setLockInfo('');
              input.focus();
            }
          };
          const iv=setInterval(update,500);
          update();
          return true;
        }
        return false;
      }

      if(await checkCooldown()) { /* wait until cooldown ends */ }

      return new Promise(res=>{
        const handler=async ()=>{
          const pin=input.value.trim(); input.value='';
          const still=await checkCooldown(); if(still) return;

          const st=getState();
          const hash=await sha256Hex(pin);
          if(hash===state.settings.passcodeHash){
            dlg.close(); toast('Unlocked'); resetAll(); setLockInfo('');
            input.removeEventListener('keydown',onEnter); $("#unlockBtn").removeEventListener('click',handler); return res(true);
          }

          // wrong
          if(st.chills<CHILLS.length){
            const attempts=st.attempts+1;
            if(attempts>=3){
              const chill=st.chills+1;
              const secs=CHILLS[st.chills];
              setState({attempts:0, chills:chill, coolUntil: Date.now()+secs*1000});
              setLockInfo(`Too many attempts. Cooling down for ${secs}s.`, 0);
              await checkCooldown();
            } else {
              setState({attempts});
              setLockInfo(`Wrong passcode. Attempts: ${attempts}/3 before cooldown.`);
            }
          } else {
            const n=st.postChillAttempts+1;
            if(n>=3){ dlg.close(); await maybeWipe(); return res(false); }
            else { setState({postChillAttempts:n}); setLockInfo(`Wrong. Final attempts: ${n}/3 before data wipe.`); }
          }
          input.focus();
        };
        const onEnter=e=>{ if(e.key==='Enter') handler(); };
        $("#unlockBtn").addEventListener('click',handler); input.addEventListener('keydown',onEnter);
      });
    }

    /* ===== Events ===== */
    $("#txForm").addEventListener("submit",(e)=>{ e.preventDefault(); const type=$("#txType").value; const amount=Number($("#txAmount").value); const category=$("#txCategory").value.trim()||"General"; const date=$("#txDate").value||todayISO(); const note=$("#txNote").value.trim(); if(!amount||amount<=0){ $("#txAmount").focus(); toast("Enter a valid amount","bad"); return; } add({type,amount,category,date,note}); e.target.reset(); $("#txType").value="EXPENSE"; $("#txDate").value=todayISO(); render(); });
    document.addEventListener("click",(e)=>{
      const del=e.target.closest("[data-del]"); const edit=e.target.closest("[data-edit]"); const budDel=e.target.closest("[data-bud-del]"); const budEdit=e.target.closest("[data-bud-edit]");
      const recDel=e.target.closest("[data-rec-del]"); const recEdit=e.target.closest("[data-rec-edit]");
      const restore=e.target.closest("[data-restore]");
      if(del){ const id=Number(del.getAttribute("data-del")); if(confirm("Delete this transaction?")){ removeTx(id); render(); } }
      if(edit){ const id=Number(edit.getAttribute("data-edit")); const t=state.transactions.find(x=>x.id===id); if(!t) return; $("#editId").value=String(t.id); $("#editType").value=t.type; $("#editAmount").value=String(t.amount); $("#editCategory").value=t.category; $("#editDate").value=t.date; $("#editNote").value=t.note||""; $("#editDlg").showModal(); }
      if(budDel){ const cat=decodeURIComponent(budDel.getAttribute("data-bud-del")); if(confirm(`Delete budget for "${cat}"?`)){ pushUndo(); delete state.budgets[cat]; persist(); render(); toast('Budget removed','good'); } }
      if(budEdit){ const cat=decodeURIComponent(budEdit.getAttribute("data-bud-edit")); const newLimit=prompt(`Set monthly limit for "${cat}"`, String(state.budgets[cat]||0)); if(newLimit!=null){ pushUndo(); state.budgets[String(cat)]=Math.max(0,Number(newLimit)||0); persist(); render(); toast('Budget saved','good'); } }

      if(recDel){ const id=Number(recDel.getAttribute("data-rec-del")); pushUndo(); state.recurring=state.recurring.filter(r=>r.id!==id); persist(); render(); }
      if(recEdit){ const id=Number(recEdit.getAttribute("data-rec-edit")); const r=state.recurring.find(x=>x.id===id); if(!r) return; const amt=prompt("Amount", String(r.amount)); if(amt==null) return; pushUndo(); r.amount=Number(amt)||0; persist(); render(); }
      if(restore){ const id=Number(restore.getAttribute("data-restore")); const idx=state.trash.findIndex(t=>t.id===id); if(idx>=0){ pushUndo(); const t=state.trash.splice(idx,1)[0]; state.transactions.push(t); persist(); render(); toast('Restored from Trash'); } }
    });
    $("#editCancel").addEventListener("click",()=>$("#editDlg").close());
    $("#editSave").addEventListener("click",()=>{ const id=Number($("#editId").value); updateTx(id,{ type:$("#editType").value, amount:Number($("#editAmount").value), category:$("#editCategory").value.trim(), date:$("#editDate").value, note:$("#editNote").value.trim() }); $("#editDlg").close(); render(); });
    $("#editDelete").addEventListener("click",()=>{ const id=Number($("#editId").value); if(confirm("Delete this transaction?")){ removeTx(id); $("#editDlg").close(); render(); } });

    $("#typeFilter").addEventListener("change",render);
    $("#categoryFilter").addEventListener("input",render);
    $("#month").addEventListener("change",render);

    $("#budForm").addEventListener("submit",(e)=>{ e.preventDefault(); const cat=$("#budCat").value.trim(); const limit=Number($("#budLimit").value); if(!cat){ $("#budCat").focus(); toast("Category required","bad"); return; } pushUndo(); state.budgets[String(cat)]=Math.max(0,Number(limit)||0); persist(); e.target.reset(); render(); toast('Budget saved','good'); });

    $("#exportCsv").addEventListener("click",()=>{ downloadFile("transactions.csv", toCSV(state.transactions), "text/csv;charset=utf-8"); toast("CSV exported"); });
    $("#exportJson").addEventListener("click",()=>{ downloadFile("budgetbuddy.json", JSON.stringify(state,null,2), "application/json"); toast("JSON exported"); });

    $("#importFile").addEventListener("change", async (e)=>{ const file=e.target.files?.[0]; if(!file) return; const text=await file.text(); try{
      pushUndo();
      if(file.name.toLowerCase().endsWith(".json") || text.trim().startsWith("{")){
        const obj=JSON.parse(text);
        state.transactions=(obj.transactions||[]).map(t=>({ id:Number(t.id), date:toISO(t.date), amount:Math.abs(Number(t.amount)||0), type:(String(t.type).toUpperCase()==="INCOME"?"INCOME":"EXPENSE"), category:String(t.category||"General"), note:String(t.note||"") }));
        state.budgets=obj.budgets||{}; if(obj.settings&&obj.settings.currency) state.settings.currency=obj.settings.currency;
        if(obj.settings&&typeof obj.settings.autoLock==='boolean') state.settings.autoLock=obj.settings.autoLock;
        state.recurring=obj.recurring||state.recurring;
        state.nextId=Number.isFinite(obj.nextId)?obj.nextId:(maxId()+1);
      } else {
        const imported=parseCSV(text); for(const r of imported){ state.transactions.push(r); state.nextId=Math.max(state.nextId,r.id+1); }
      }
      await persist(); toast("Import complete"); e.target.value=""; render();
    }catch(err){ toast("Import failed: "+err.message,'bad'); } });

    $("#clearAll").addEventListener("click", async ()=>{ if(confirm('Type "YES" to wipe everything."')){ const sure=prompt('Confirm by typing YES'); if(sure==="YES"){ state.transactions=[]; state.budgets={}; state.recurring=[]; state.trash=[]; state.nextId=1; await persist(); render(); toast("All data cleared",'bad'); } } });

    $("#changeStorage").addEventListener("click",()=>$("#storageDlg").showModal());
    $("#pickBrowser").addEventListener("click", async ()=>{ storageMode='local'; await idb.set(MODE_KEY,storageMode); await idb.del('dataHandle'); fileHandle=null; lsSync(); $("#storageDlg").close(); renderStorageBadge(); toast("Using Browser Storage"); });
    $("#pickFile").addEventListener("click", async ()=>{ if(!('showSaveFilePicker' in window)){ toast('File picker not supported here','bad'); return; } try{ const handle=await window.showSaveFilePicker({ suggestedName:'budgetbuddy-data.json', types:[{ description:'JSON file', accept:{ 'application/json':['.json'] } }] }); fileHandle=handle; storageMode='file'; await idb.set('dataHandle',fileHandle); await idb.set(MODE_KEY,storageMode); const file=await fileHandle.getFile(); if((file.size||0)>0) await fileLoad(); else await fileSave(); $("#storageDlg").close(); renderStorageBadge(); render(); toast("Saving to your chosen file"); }catch(e){ if(!(e && e.name==='AbortError')) toast('Could not choose file','bad'); } });

    $("#openSettings").addEventListener("click",()=>{ $("#currencySelect").value=state.settings.currency||'USD'; $("#customCurr").value=''; $("#autoLockToggle").checked=!!$("#autoLockToggle").checked; $("#settingsDlg").showModal(); });
    $("#saveCurrency").addEventListener("click", async ()=>{ const sel=$("#currencySelect").value; const custom=$("#customCurr").value.trim().toUpperCase(); state.settings.currency=custom||sel||'USD'; state.settings.autoLock=!!$("#autoLockToggle").checked; await persist(); $("#currLabel").textContent=state.settings.currency; $("#settingsDlg").close(); render(); toast('Settings saved'); });
    $("#closeSettings").addEventListener("click",()=>$("#settingsDlg").close());
    $("#savePin").addEventListener("click", async ()=>{ const a=$("#newPin").value.trim(); const b=$("#confirmPin").value.trim(); if(!/^\d{4,8}$/.test(a)){ toast('Passcode must be 4–8 digits','bad'); return; } if(a!==b){ toast('Passcodes do not match','bad'); return; } state.settings.passcodeHash=await sha256Hex(a); $("#newPin").value=$("#confirmPin").value=''; await persist(); toast('Passcode set'); });
    $("#clearPin").addEventListener("click", async ()=>{ state.settings.passcodeHash=null; await persist(); toast('Passcode removed'); });
    $("#lockNow").addEventListener("click", async ()=>{ if(!state.settings.passcodeHash){ toast('No passcode set (Settings)','bad'); return; } await lockScreen(); });

    // Recurring dialog
    $("#openRecurring").addEventListener("click",()=>{ $("#recStart").value=todayISO(); $("#recurringDlg").showModal(); renderRecurringTable(); });
    $("#closeRecurring").addEventListener("click",()=>$("#recurringDlg").close());
    $("#recForm").addEventListener("submit",(e)=>{ e.preventDefault(); const r={ id: Date.now(), type:$("#recType").value, amount:Math.abs(Number($("#recAmount").value)||0), category:$("#recCategory").value.trim()||'General', note:$("#recNote").value.trim(), freq:$("#recFreq").value, nextDate: $("#recStart").value || todayISO() }; if(!r.amount){ toast('Amount required','bad'); return; } pushUndo(); state.recurring.push(r); persist(); render(); toast('Recurring added'); });

    // Trash dialog
    $("#openTrash").addEventListener("click",()=>{ renderTrash(); $("#trashDlg").showModal(); });
    $("#closeTrash").addEventListener("click",()=>$("#trashDlg").close());
    $("#purgeTrash").addEventListener("click",()=>{ if(confirm('Permanently delete all items in Trash?')){ pushUndo(); state.trash=[]; persist(); renderTrash(); toast('Trash purged','bad'); } });

    if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }); }
    init();

    /* ===== Custom tooltip manager (auto-hide 3s) ===== */
    function initTooltips(){
      const tip = document.createElement('div');
      tip.className = 'bb-tooltip';
      document.body.appendChild(tip);
      let hideTimer = null;
      let currentAnchor = null;

      function showTip(anchor){
        const text = anchor.getAttribute('data-tip');
        if(!text) return;
        tip.textContent = text;
        tip.style.left = '-9999px';
        tip.style.top = '-9999px';
        tip.classList.add('show');

        const r = anchor.getBoundingClientRect();
        const tr = tip.getBoundingClientRect();
        let x = r.left + (r.width - tr.width)/2;
        let y = r.top - tr.height - 8;
        x = Math.max(8, Math.min(x, window.innerWidth - tr.width - 8));
        if(y < 8){ y = r.bottom + 8; }
        tip.style.left = `${Math.round(x)}px`;
        tip.style.top = `${Math.round(y)}px`;

        if(hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(hide, 3000);
        currentAnchor = anchor;
        anchor.setAttribute('aria-describedby','bbtip');
      }
      function hide(){
        tip.classList.remove('show');
        if(hideTimer) clearTimeout(hideTimer);
        hideTimer = null;
        if(currentAnchor){ currentAnchor.removeAttribute('aria-describedby'); currentAnchor = null; }
      }
      tip.id = 'bbtip';

      function onEnter(e){
        const el = e.currentTarget;
        showTip(el);
      }
      function onLeave(){
        hide();
      }
      function onFocus(e){ showTip(e.currentTarget); }
      function onBlur(){ hide(); }

      const anchors = [...document.querySelectorAll('[data-tip]')];
      anchors.forEach(a=>{
        a.addEventListener('mouseenter', onEnter);
        a.addEventListener('mouseleave', onLeave);
        a.addEventListener('focus', onFocus);
        a.addEventListener('blur', onBlur);
        a.addEventListener('touchstart', (e)=>{ showTip(e.currentTarget); }, {passive:true});
        a.addEventListener('touchend', hide, {passive:true});
      });

      window.addEventListener('scroll', ()=>{ if(currentAnchor) hide(); }, {passive:true});
      window.addEventListener('resize', ()=>{ if(currentAnchor) hide(); });
    }
  })();
  </script>
</body>
</html>
